---
config:
  theme: neo
---
graph TD
    A[开始] --> B{检查命令行参数};
    B --> |参数无效| C[打印错误并退出];
    B --> |参数有效| D[初始化 Winsock];
    D --> E{初始化成功?};
    E --> |失败| F[打印错误并退出];
    E --> |成功| G[枚举本机网卡];
    G --> H[显示网卡列表并获取用户选择];
    H --> I{用户选择有效?};
    I --> |无效| J[打印错误并退出];
    I --> |有效| K[创建原始套接字 Socket];
    K --> L{创建成功?};
    L --> |失败| M[打印错误并退出];
    L --> |成功| N[绑定套接字到选定网卡的IP];
    N --> O{绑定成功?};
    O --> |失败（可能需管理员权限）| P[打印错误并退出];
    O --> |成功| Q[开启网卡混杂模式 SIO_RCVALL];
    Q --> R{开启成功?};
    R --> |失败（可能需管理员权限）| S[打印错误并退出];
    R --> |成功| T[启动一个独立的显示线程<br>用于实时刷新统计数据];
    T --> U[进入主循环: 开始抓包];
    U --> V{抓包时间未结束?};
    V --> |是| W[接收网络数据包 recv];
    W --> X{成功接收数据?};
    X --> |否| U;
    X --> |是| Y[解析IP包头<br>获取源/目的IP和协议];
    Y --> Z{是否为本机相关流量?};
    Z --> |否| U;
    Z --> |是| AA[更新统计数据<br>（存入map）];
    AA --> U;
    V --> |否| BB[停止显示线程];
    BB --> CC[关闭套接字];
    CC --> DD[清理 Winsock 环境];
    DD --> EE[打印结束信息];
    EE --> Fim[结束];
    subgraph "清理与退出"
        C
        F
        J
        M
        P
        S
        Fim
    end
    subgraph "核心抓包循环"
        U
        V
        W
        X
        Y
        Z
        AA
    end
    subgraph "初始化与配置"
       B
       D
       G
       H
       K
       N
       Q
       T
    end
